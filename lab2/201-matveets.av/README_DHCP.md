# DHCP сервер
## О протоколе
DHCP (Dynamic Host Configuration Protocol) — протокол прикладного уровня модели TCP/IP, используется для динамической конфигурации параметров сетевых устройств.

### Структура пакета DHCP
Структура пакета DHCP выглядит следующим образом:
```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     op (1)    |   htype (1)   |   hlen (1)    |   hops (1)    |
+---------------+---------------+---------------+---------------+
|                            xid (4)                            |
+-------------------------------+-------------------------------+
|           secs (2)            |           flags (2)           |
+-------------------------------+-------------------------------+
|                          ciaddr  (4)                          |
+---------------------------------------------------------------+
|                          yiaddr  (4)                          |
+---------------------------------------------------------------+
|                          siaddr  (4)                          |
+---------------------------------------------------------------+
|                          giaddr  (4)                          |
+---------------------------------------------------------------+
|                                                               |
|                          chaddr  (16)                         |
|                                                               |
|                                                               |
+---------------------------------------------------------------+
|                                                               |
|                          sname   (64)                         |
+---------------------------------------------------------------+
|                                                               |
|                          file    (128)                        |
+---------------------------------------------------------------+
|                                                               |
|                          options (variable)                   |
+---------------------------------------------------------------+
```
Назначения каждого из полей:
* **op** - Тип сообщения. Например, может принимать значения: BOOTREQUEST (0x01, запрос от клиента к серверу) и BOOTREPLY (0x02, ответ от сервера к клиенту).
* **htype**	- Тип аппаратного адреса. Допустимые значения этого поля определены в RFC 1700 «Assigned Numbers». Например, для MAC-адреса Ethernet это поле принимает значение 0x01.
* **hlen** - Длина аппаратного адреса в байтах. Для MAC-адреса Ethernet —0x06.
* **hops** - Количество промежуточных маршрутизаторов (так называемых агентов ретрансляции DHCP), через которые прошло сообщение. Клиент устанавливает это поле в 0x00.
* **xid** - Уникальный идентификатор транзакции в 4 байта, генерируемый клиентом в начале процесса получения адреса.
* **secs** - Время в секундах с момента начала процесса получения адреса. Может не использоваться (в этом случае оно устанавливается в 0x0000).
* **flags** - Поле для флагов — специальных параметров протокола DHCP.
* **ciaddr** - IP-адрес клиента. Заполняется только в том случае, если клиент уже имеет собственный IP-адрес и способен отвечать на запросы ARP 
(это возможно, если клиент выполняет процедуру обновления адреса по истечении срока аренды).
* **yiaddr** - Новый IP-адрес клиента, предложенный сервером.
* **siaddr** - IP-адрес сервера. Возвращается в предложении DHCP.
* **giaddr** - IP-адрес агента ретрансляции, если таковой участвовал в процессе доставки сообщения DHCP до сервера.
* **chaddr** - Аппаратный адрес (обычно MAC-адрес) клиента.
* **sname** - Необязательное имя сервера в виде нуль-терминированной строки.
* **file** - Необязательное имя файла на сервере, используемое бездисковыми рабочими станциями при удалённой загрузке. Как и sname, представлено в виде нуль-терминированной строки.
* **options** -	Поле опций DHCP. Здесь указываются различные дополнительные параметры конфигурации. 
В начале этого поля указываются четыре особых байта со значениями 99, 130, 83, 99 («волшебные числа»), позволяющие серверу определить наличие этого поля. 
Поле имеет переменную длину, однако DHCP-клиент должен быть готов принять DHCP-сообщение длиной в 576 байт (в этом сообщении поле options имеет длину 340 байт).

### Процесс передачи данных
Работа протокола DHCP начинается с того, что клиент, которому необходима динамическая конфигурация, шлет запрос DISCOVERY. 
В ответ сервер шлет предложение OFFER, в котором указывает адрес, который он назначает клиенту, а также заполняет опции соответствующими значениями.

Клиент может получить несколько предложений OFFER от разных DHCP-серверов (если их несколько), какому из серверов отдать предпочтение, выбирает сам клиент. 
Обычно клиент выбирает тот сервер, от которого он первым получил предложение.

После того, как клиент определяет для себя сервер, с которого он хочет получить конфигурацию, он отправляет запрос REQUEST. 
Запрос отправляется широковещательно, чтобы его могли получить все DHCP-сервера, а адрес того сервера, который выбрал клиент, указывается в специальной опции 54 (DHCP Server Identifier).
Таким образом клиент говорит всем серверам в широковещательном домене, какому из них он отдал предпочтение.

Следующим шагом является подтверждение запроса (сообщение ACK) со стороны сервера. Сервер также широковещательно рассылает подтверждение, но в теле сообщения явным образом указывает МАС-адрес клиента.

## Запуск программы

Чтобы запустить программу достаточно выполнить:

```
python3 server.py
```

По умолчанию адрес 0.0.0.0 и порт 67.

## Пример работы

```
DHCP server running on 0.0.0.0 : 67

Message received from:  ('192.168.31.245', 68)
Message type:  1
DHCPDISCOVER accepted
Offered address:  [192, 168, 1, 100]
Send DHCPOFFER to:  ('192.168.31.245', 68)

Message received from:  ('192.168.31.245', 68)
Message type:  3
DHCPREQUEST accepted
Assigned address:  [192, 168, 1, 100]
Send DHCPACK to:  ('192.168.31.245', 68)
```
