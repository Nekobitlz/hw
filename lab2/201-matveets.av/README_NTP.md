# NTP клиент
## О протоколе

*NTP (Network Time Protocol)* — протокол, который работает поверх UDP и используется для синхронизации локальных часов с часами на сервере
точного времени. Актуальная версия протокола — 4, поэтому будем использовать именно её.

### Структура пакета NTP

Структура пакета NTP выглядит следующим образом:

```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|LI | VN  |Mode |    Stratum     |     Poll      |  Precision   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Root Delay                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Root Dispersion                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Reference ID                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                     Reference Timestamp (64)                  +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                      Origin Timestamp (64)                    +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                      Receive Timestamp (64)                   +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                      Transmit Timestamp (64)                  +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
.                                                               .
.                    Extension Field 1 (variable)               .
.                                                               .
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
.                                                               .
.                    Extension Field 2 (variable)               .
.                                                               .
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Key Identifier                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                            dgst (128)                         |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

Назначения каждого из полей:

* **Leap indicator (LI), 2 бита** — число, предупреждающее о секунде координации. Может быть от 0 до 3, где 0 — нет коррекции, 1 — последняя
  минута дня содержит 61 с, 2 — последняя минута дня содержит 59 с, 3 — неисправность сервера. При значении 3 полученным данным доверять не
  следует. Вместо этого нужно обратиться к другому серверу. Наш псевдосервер будет всегда возвращать 0.
* **Version number (VN), 3 бита** — номер версии протокола NTP (1–4). Мы поставим туда 3.
* **Mode, 3 бита** — режим работы отправителя пакета. Значение от 0 до 7, где 3 — клиент, а 4 — сервер.
* **Stratum, 1 байт** — сколько посредников между клиентом и эталонными часами (включая сам NTP-сервер). 1 — сервер берет данные
  непосредственно с атомных (или других точных) часов, то есть между клиентом и часами только один посредник (сам сервер); 2 — сервер берет
  данные с сервера со значением Stratum 1 и так далее.
* **Poll, 1 байт** — целое число, задающее интервал в секундах между последовательными обращениями. Клиент может указать здесь интервал, с
  которым он хочет отправлять запросы на сервер, а сервер — интервал, с которым он разрешает, чтобы его опрашивали.
* **Precision (точность), 1 байт** — число, которое сообщает точность локальных системных часов. Значение равно двоичному логарифму секунд.
* **Root delay (задержка сервера), 4 байта** — время, за которое показания эталонных часов доходят до сервера NTP. Задается как число секунд
  с фиксированной запятой.
* **Root dispersion, 4 байта** — разброс показаний сервера.
* **RefID, 4 байта** (идентификатор источника) — ID часов. Если поле Stratum равно единице, то RefID — имя атомных часов (четыре символа
  ASCII). Если текущий сервер NTP использует показания другого сервера, то в RefID записан IP-адрес этого сервера.
* **Reference, 8 байт** — последние показания часов сервера.
* **Originate, 8 байт** — время, когда пакет был отправлен, по версии сервера.
* **Receive, 8 байт** — время получения запроса сервером.
* **Transmit, 8 байт** — время отправки ответа сервера клиенту, которое заполняет клиент.

### Процесс передачи данных

В целом процесс проброса трафика через NTP протокол следующий. Клиент посылает запрос на сервер, состоящий из номера версии, режима (в нашем
случае, 3 = client) и времени отправки пакета. Сервер принимает пакет, запоминает и записывает в пакет время приема, заполняет время
отправки и отвечает клиенту. Клиент запоминает, когда он получил ответ, и получает нечто вроде RTT (Round-Trip Time, в простонародье — пинг)
до сервера. Дальше он определяет, сколько времени понадобилось пакету, чтобы дойти от сервера обратно ему (время между запросом и ответом
клиента минус время обработки пакета на сервере, деленное на два). 

### Формат времени

Время представляется в системе NTP 64-битным числом (8 байт), состоящим из 32-битного счётчика секунд и 32-битного счётчика долей секунды,
позволяя передавать время в диапазоне 2^32 секунд, с теоретической точностью 2^(−32) секунды. Поскольку шкала времени в NTP повторяется
каждые 2^32 секунды (136 лет), получатель должен хотя бы примерно знать текущее время (с точностью 68 лет). Также следует учитывать, что
время отсчитывается с полуночи 1 января 1900 года, а не с 1970, поэтому из времени NTP нужно вычитать 70 лет (с учётом високосных лет),
чтобы корректно совместить время с Windows или Unix-системами.

## Запуск программы

Чтобы запустить программу достаточно выполнить:

```
python3 client.py
```

По умолчанию программа подключается к pool.ntp.org и сервер настраивать не нужно.

## Пример работы

Корректная работа:
```
Server: pool.ntp.org
Server time:  2021-12-25 05:34:03.163673
Client time:  2021-12-25 05:34:03.031876
Round trip time: 150 ms
Offset: 57 ms
```

При превышении времени запроса выдается ошибка:
```
Server: pool.ntp.org
Timed out, please try to connect later
```